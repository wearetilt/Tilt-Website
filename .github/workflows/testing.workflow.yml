name: Deploy to Testing

on:
  push:
    branches: [ testing ]
  workflow_run:
    workflows: [ "Sync environments" ]
    types:
      - completed

jobs:
  deploy-to-testing:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.ref == 'refs/heads/testing' }}
    name: Deploy to Testing
    runs-on: ubuntu-latest
    steps:
      - name: REQUIRED - Set repo permissions for deployment
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.TESTING_REMOTE_HOST }}
          user: ${{ secrets.TESTING_REMOTE_DEPLOYMENT_USER }}
          key: ${{ secrets.TESTING_REMOTE_PRIVATE_KEY}}
          command: |
            sudo chown -R ${{ secrets.TESTING_REMOTE_DEPLOYMENT_USER }}:${{ secrets.TESTING_REMOTE_DEPLOYMENT_USER }} ${{ secrets.TESTING_REMOTE_REPO_DIRECTORY }}

      - name: REQUIRED - Checkout latest
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.TESTING_REMOTE_HOST }}
          user: ${{ secrets.TESTING_REMOTE_DEPLOYMENT_USER }}
          key: ${{ secrets.TESTING_REMOTE_PRIVATE_KEY}}
          command: |
            cd ${{ secrets.TESTING_REMOTE_REPO_DIRECTORY }}
            git fetch
            git stash
            git checkout testing
            git merge origin/testing

      - name: REQUIRED - Build assets and dependencies
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.TESTING_REMOTE_HOST }}
          user: ${{ secrets.TESTING_REMOTE_DEPLOYMENT_USER }}
          key: ${{ secrets.TESTING_REMOTE_PRIVATE_KEY}}
          command: |
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            nvm use 13.13.0
            cd ${{ secrets.TESTING_REMOTE_REPO_DIRECTORY }}
            npm run production
            composer install --ignore-platform-reqs

      - name: REQUIRED - Reset permissions
        uses: fifsky/ssh-action@master
        with:
          host: ${{ secrets.TESTING_REMOTE_HOST }}
          user: ${{ secrets.TESTING_REMOTE_DEPLOYMENT_USER }}
          key: ${{ secrets.TESTING_REMOTE_PRIVATE_KEY}}
          command: |
            sudo chown -R ${{ secrets.TESTING_REMOTE_WEB_USER }}:${{ secrets.TESTING_REMOTE_WEB_USER }} ${{ secrets.TESTING_REMOTE_REPO_DIRECTORY }}
            sudo chown -R root:root ${{ secrets.TESTING_REMOTE_REPO_DIRECTORY }}/.htpasswd
